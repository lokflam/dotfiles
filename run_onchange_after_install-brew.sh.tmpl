#!/bin/bash
# Brewfile hash: {{ include "Brewfile" | sha256sum }}
# mise config hash: {{ include "dot_config/mise/config.toml.tmpl" | sha256sum }}

set -e 

# Ensure Brew is in the current script path
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

# 1. Install Brew Packages
echo "üì¶ Installing Homebrew packages..."
brew bundle --file={{ joinPath .chezmoi.sourceDir "Brewfile" | quote }}

# 2. Switch Shell
BREW_ZSH="$(brew --prefix)/bin/zsh"
if ! grep -Fxq "$BREW_ZSH" /etc/shells; then
    echo "üì¶ Registering zsh to shells..."
    sudo sh -c "echo $BREW_ZSH >> /etc/shells"
fi
if "$SHELL" != "$BREW_ZSH"; then
    echo "üì¶ Switching shell to zsh..."
    chsh -s "$BREW_ZSH"
fi

# 3. Export the token so this session of mise install can see it
export GITHUB_TOKEN={{ .github_token | quote }}

# 4. Mise Install
# Using brew path to call mise to ensure it's the one we just installed
echo "üõ†Ô∏è Installing Mise tools..."
$(brew --prefix)/bin/mise install
