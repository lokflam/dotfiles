#!/bin/bash
# Brewfile hash: {{ include "Brewfile" | sha256sum }}
# mise config hash: {{ include "dot_config/mise/config.toml" | sha256sum }}

set -e 

# Ensure Brew is in the current script path
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

# 1. Install Brew Packages
echo "ğŸ“¦ Installing Homebrew packages..."
brew bundle --file={{ joinPath .chezmoi.sourceDir "Brewfile" | quote }}

# 2. Switch Shell
echo "ğŸ“¦ Switching shell to zsh..."
BREW_ZSH="$(brew --prefix)/bin/zsh"
if ! grep -Fxq "$BREW_ZSH" /etc/shells; then
    sudo sh -c "echo $BREW_ZSH >> /etc/shells"
fi
[ "$SHELL" != "$BREW_ZSH" ] && chsh -s "$BREW_ZSH"

# 3. Try to get the token from gh (if logged in)
if command -v gh &> /dev/null; then
    # We export it so Mise can see it
    export GITHUB_TOKEN=$(gh auth token 2>/dev/null)
fi

# 4. Mise Install
# Using brew path to call mise to ensure it's the one we just installed
echo "ğŸ› ï¸ Installing Mise tools..."
$(brew --prefix)/bin/mise install
