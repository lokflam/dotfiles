#!/bin/bash
# Brewfile hash: {{ include "Brewfile" | sha256sum }}

set -e 

echo "üöÄ Starting System Bootstrap..."

# 1. Install System Dependencies (The fix for your GCC error)
# Homebrew on Linux REQUIRES these to link binaries correctly.
echo "üì¶ Installing system build tools via apt..."
sudo apt update
sudo apt install -y build-essential

# 2. Install Homebrew if missing
if ! command -v brew &> /dev/null; then
    echo "üç∫ Installing Homebrew..."
    NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Ensure Brew is in the current script path
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

# 3. Install Brew Packages
echo "üì¶ Installing Homebrew packages..."
brew bundle --file={{ joinPath .chezmoi.sourceDir "Brewfile" | quote }}

# 4. Switch Shell
echo "üì¶ Switching shell to zsh..."
BREW_ZSH="$(brew --prefix)/bin/zsh"
if ! grep -Fxq "$BREW_ZSH" /etc/shells; then
    sudo sh -c "echo $BREW_ZSH >> /etc/shells"
fi
[ "$SHELL" != "$BREW_ZSH" ] && chsh -s "$BREW_ZSH"

# 5. Mise Install
# Using brew path to call mise to ensure it's the one we just installed
echo "üõ†Ô∏è Installing Mise tools..."
$(brew --prefix)/bin/mise install
